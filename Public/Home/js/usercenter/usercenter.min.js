var type=1;var countLast,unConfirmCountLast;var seconds=10000;var timeInt=startInter(10000);$(document).ready(function(){getOrderList(1,1);getPriceBychangeCoin();var a=JSON.parse(localStorage.getItem("box-pai"));if(a){$("#search_tab .SearchArea").find("i").eq(0).html(a.areaIdHTML);$("body #buyAreaId").val(a.areaId);getBankInfoByArea(a.areaId);setTimeout(function(){$("body #buyBankId").val(a.bankId).trigger("change")},1000);$("#num1").val(a.num1);$("#num2").val(a.num2);$("#price1").val(a.price1);$("#price2").val(a.price2)}});$(function(){$("body").on("click","#getAllOrder",function(){type=1;getOrderList(1,1);stopInter(timeInt);timeInt=startInter(seconds)});$("body").on("click","#getBuyOrder",function(){type=2;getOrderList(1,2);stopInter(timeInt);timeInt=startInter(seconds)});$("body").on("click","#getSellOrder",function(){type=3;getOrderList(1,3);stopInter(timeInt);timeInt=startInter(seconds)});$("body").on("click","#getOverBuyOrder",function(){type=4;getOrderList(1,4);timeInt=stopInter(timeInt)});$("body").on("click","#getOverSellOrder",function(){type=5;getOrderList(1,5);timeInt=stopInter(timeInt)});$("body").on("click","#getRevokeOrder",function(){type=6;getOrderList(1,6);timeInt=stopInter(timeInt)});$("body").on("click","#queryPendingOrder",function(){var a=getPendingPurchaseOrderList();$("#search").modal("hide");var b=["HK","TW","CN"];$("#search_tab .SearchArea").find("i").eq(0).html(b[a.areaId-1]);var c={areaId:a.areaId,areaIdHTML:b[a.areaId-1],bankId:a.bankId,currencyId:a.currencyId,num1:a.num1,num2:a.num2,price1:a.price1,price2:a.price2};localStorage.setItem("box-pai",JSON.stringify(c))});$("body").on("change","#buyAreaId",function(){var a=$(this).val();getBankInfoByArea(a)});$("body").on("click",'button[data-target="#sell"]',function(){getUserBindBank();getNowMoney()});$("body").on("change","#userArea",function(){getUserBindBank();getNowMoney();referenceTotalPrice()});$("body").on("change","#userBindBank",function(){var c=$("#userBindBank");var b=c.find("option:selected").attr("bank-num"),a=c.find("option:selected").text();$("#bankName").html(a);$("#bankNum").html(b)});$("body").on("click","#subSellInfo",function(){var a=$(this);setTimeSecd(a);checkSubParams(a)});$("body").on("click","#sell .close",function(){$(".saletotal,.referenceSaletotal").text("0.00")});$("body").on("click","#confirmPayMoney",function(){var a=$(this);setTimeSecd(a);confirmOrderBuyOrAccept(a)});$("body").on("click","#confirmAccept",function(){var a=$(this);setTimeSecd(a);confirmOrderPayOrAccept(a)});$("body").on("click","#buySubInfo",function(){var a=$(this);subBuyInfo(a);setTimeSecd(a)});$("body").on("click","#revokeOrderById",function(){var a=$(this).attr("order-id");revokeOrderById(a)});$("body").on("click",".getDetails",function(){getOrderDeatil($(this));$("#detail").show()});$("body").on("click",".revokeNowOrder",function(){$("#revokeOrderById").attr("order-id",$(this).attr("order-id"))});$("body").on("click",".confirmOrder",function(){getBankInfo($(this),1)});$("body").on("click",".bankInfo",function(){getBankInfo($(this),2)});$("body").on("click",".confirmAccept",function(){var c=$(this);var a=c.attr("order-id");var b=c.attr("amount_count");$("#confirmAccept").attr("order-id",a);$("#unconfirmAccept").attr("order-id",a);if(b>0){$("#unconfirmAccept").attr("disabled",true)}if(unConfirmCountLast!="undefined"){clearInterval(unConfirmCountLast)}unconfirmCountdown(b);getBankInfo(c,3)});$("body").on("click",".small-Trading",function(){if(Maintain(dealOrder,P2P_Maintain_order,P2P_Maintain_Pattern)){$(this).find("ul").remove();return}});$("#touchspin-example4").bind("input propertychange",function(){var a=$(this);if(a.val()==""){$(".price-show").text("0.00");SaleTotal();referenceTotalPrice();return}validationNumber(a,1);$(".price-show").text(a.val());SaleTotal();referenceTotalPrice()});$("#coinNum").bind("input propertychange",function(){var a=$(this);if(a.val()==""){$(".quantity-show").text("0.0000");SaleTotal();referenceTotalPrice();return}validationNumber(a,2);$(".quantity-show").text(a.val());SaleTotal();referenceTotalPrice()});$("body").on("click","#unconfirmAccept",function(){var c=$(this);setTimeSecd(c);var b=c.attr("order-id");var a=$("#payTradePwd").val();check_user("/OffTrading/unGetMoney",{order_id:b,tradePwd:a,},"post").then(function(d){if(d.code==200){BottomalertBox("bottom",d.msg,"success","center");$("#static1").modal("hide");$(".confirmOrder-"+b).remove();$(".confirmBtn-"+b).html(d.data.status_str);loadLate(2000)}else{BottomalertBox("bottom",d.msg,"fail","center")}})})});function stopInter(a){if(a){clearInterval(a);a=null}return a}function startInter(b){var a=setInterval(function(){var c=$("#dataPage"+type+" li.pagation-active .current-page").text();getOrderListForPage(c)},b);return a}function getNowMoney(){var d=$("#userArea").val();var b=getPriceBychangeCoin(d);var c=$("#coinRtqMoney").html();c=ChangeFixed(c,3);var a=c*b[1];if(d==2){a=ChangeFixed(a,1)+"00"}a=ChangeFixed(a,3);$("#nowMoney").html(c);$(".referenceMoney-price").text(b[0]);$("#referenceMoney").html(a)}function subBuyInfo(f){var b=f.attr("buy-order-id");var c=f.attr("user-bank-id");var d=f.attr("currency-id");var a=$("#buyTradePwd").val();var e=$("#buyVerifyCode").val();if(!a){BottomalertBox("bottom",pwdMsg,"fail","center");return false}check_user("/OffTrading/buying",{orderId:b,bankId:c,currencyId:d,tradePwd:a,verifyCode:e},"post").then(function(g){if(g.code==200){BottomalertBox("bottom",g.msg,"success","center");loadLate(2000)}else{if(g.code==233){BottomalertBox("bottom",g.msg,"fail","center")}else{$("#static").modal("hide");BottomalertBox("bottom",g.msg,"fail","center")}}})}function getBankInfoByArea(a){check_user("/UserCenter/getBankInfoByArea",{areaId:a,},"post").then(function(c){var f=c.bankInfo;var g=$("#buyBankId");var e=g.parents(".btn-group.bootstrap-select");e.children("button").attr("title","");g.empty();if(f){g.find("optgroup").remove();var d="";for(var b in f){d+='<option value="'+f[b].id+'" >'+f[b].bank_name+"</option>"}d+="</optgroup>";g.append(d).selectpicker("refresh")}})}function checkUserBindBank(){return $.ajax({type:"post",url:"/UserCenter/checkUserBindBank",data:"",dataType:"json",success:function(a){if(a.code!=200){alertBox(a.msg)}return a}})}function checkSubParams(g){var a=$("#touchspin-example4").val();var d=$("#coinNum").val();var c=$("#userBindBank").val();var e=true;var f="";var b=g.attr("currency-id");ajaxPromise.then(function(){return isRealName()}).then(function(h){if(h.code==200){return checkTradePwd()}return h}).then(function(h){if(h.code==200){return checkUserBindBank()}return h}).then(function(h){if(h.code==200){return checkIsOvertime()}return h}).then(function(h){if(h.code==200){return checkIsCompleteOrder(b,2)}return h}).then(function(h){if(h.code==200){var m=$("#userArea").val();var k=$("#userBindBank").val();var j=$("#touchspin-example4").val();var l=$("#coinNum").val();var i=$("#sellPwd").val();if(!k){alertBox(bankMsg);return false}if(j<=0){BottomalertBox("bottom",priceMsg,"fail","center");return false}if(l<=0){BottomalertBox("bottom",numMsg,"fail","center");return false}if(!i){BottomalertBox("bottom",pwdMsg,"fail","center");return false}$.ajax({type:"post",url:"/OffTrading/selling",data:{currencyId:b,userArea:m,transpwd:i,userBankId:k,coinPrice:j,coinNum:l},dataType:"json",success:function(n){if(n.code==200){$("#ConfirmPass").modal("hide");BottomalertBox("bottom",n.msg,"success","center");loadLate(2000)}else{BottomalertBox("bottom",n.msg,"fail","center")}}})}})}function getUserBindBank(){var b=$("#userArea").val(),a="";check_user("/UserCenter/getUserBindBank",{areaId:b},"post").then(function(f){var g="",e="",d="";if(f!=""){for(var c in f){if(f[c].default_status==1){g='selected="true"';d=f[c].bank_name;e=f[c].bank_num}else{if(c==0){g='selected="true"';d=f[c].bank_name;e=f[c].bank_num}}a+='<option bank-num="'+f[c].bank_num+'" value="'+f[c].id+'" '+g+">"+f[c].bank_name+"</option>";g=""}}else{d=bindBankTips;a='<option value="">'+d+"</option>"}$("#bankName").html(d);$("#bankNum").html(e);$("#userBindBank").html(a).selectpicker("refresh");$("#select2-userBindBank-container").attr("title",d).html(d)})}function getIdAttr(b){var a="";switch(b){case 1:a="myOrderListAll";break;case 2:a="myOrderListBuy";break;case 3:a="myOrderListSale";break;case 4:a="myOverBuyOrder";break;case 5:a="myOverSaleOrder";break;case 6:a="myRevokeOrder";break;default:a="myOrderListAll";break}return a}function getOrderListForPage(a){getOrderList(a,type)}function timeLast(a){countLast=setInterval(function(){$("#"+a+" .remaining_time").each(function(){var c=$(this);var b=Number(c.attr("time"));b--;if(b>0){c.attr("time",b).text(P2P_formatSeconds(b))}if(b<=0){c.text(c.attr("status-str")).removeClass("remaining_time").next().html(remainingTime_staus)}})},1000)}function clearLast(){if(countLast!="undefined"){clearInterval(countLast)}}function unconfirmCountdown(b){var a=Number(b);unConfirmCountLast=setInterval(function(){a--;if(a<=0){$("#unconfirmAccept").attr("disabled",false)}},1000)}function getOrderList(c,b){if(c=="undefined"){c=1}var a=getIdAttr(b);check_user("/OffTrading/getOrderList",{type:b,p:c},"get").then(function(e){var f="";var h=e.data;var g=e.page_show;for(var d in h){f+=getOrderListHtml(h[d])}f+="<td ></td>";$("#dataPage"+b).html(g);$("#"+a).html(f);if(countLast!="undefined"){clearInterval(countLast)}timeLast(a)})}function getBankInfo(c,b){var a=c.attr("order-id");check_user("/OffTrading/getUserBankInfo",{order_id:a},"post").then(function(d){if(d.code==200){processBankInfo(d.data.bank_info,b)}else{BottomalertBox("bottom",d.msg,"fail","center")}})}function processBankInfo(b,a){var c;switch(a){case 1:$("#bank_num").val(b.bank_num);$("#bank_user_name").val(b.bank_real_name);$("#bank_name").val(b.bank_name);$("#confirmPayMoney").html(b.btn_str).attr("order-id",b.order_id);if(b.bank_address){$("#bank_user_address").val(b.bank_address);$("#bank_address").show()}else{$("#bank_address").hide()}break;case 2:c=$("#payinfoMess");c.find("#payname").val(b.bank_real_name);c.find("#pay_bankname").val(b.bank_name);c.find("#pay_time").val(b.pay_time);break;case 3:c=$("#static1");c.find(".bank_uname").text(b.buy_name);c.find(".bank_name").text(b.bank_name);c.find(".pay_time").text(b.pay_time);break}}function confirmOrderBuyOrAccept(b){var a=b.attr("order-id");check_user("/OffTrading/confirmOrderPaidOrOrderAccept",{order_id:a},"post").then(function(c){if(c.code==200){BottomalertBox("bottom",c.msg,"success","center");$("#payinfo").modal("hide");$(".confirmOrder-"+a).remove();$(".confirmBtn-"+a).html(c.data.status_str);loadLate(2000)}else{BottomalertBox("bottom",c.msg,"fail","center")}})}function confirmOrderPayOrAccept(c){var b=c.attr("order-id");var a=$("#payTradePwd").val();check_user("/OffTrading/confirmOrderPaidOrOrderAccept",{order_id:b,tradePwd:a,},"post").then(function(d){if(d.code==200){BottomalertBox("bottom",d.msg,"success","center");$("#static1").modal("hide");$(".confirmOrder-"+b).remove();$(".confirmBtn-"+b).html(d.data.status_str);loadLate(2000)}else{BottomalertBox("bottom",d.msg,"fail","center")}})}function getOrderListHtml(b){var a='<tr class="order-list-id-'+b.id+'">';a+="<td>"+b.buy_str+"</td>";a+="<td>"+b.coin_name+"</td>";a+="<td>"+b.price+"</td>";a+="<td>"+b.num+"</td>";a+="<td>"+b.total_price+"</td>";a+="<td>"+b.total_rate+"</td>";if(b.status_flag!=1){a+=getHtmlByFlage(b)}else{a+=getDetailHtml(b);a+="<td>"+b.status_str+"</td>"}a+="</tr>";return a}function getHtmlByFlage(c){var a;if(c.complete_flag==1){a=getDetailHtml(c)}else{a="<td>"+c.status_str+"</td>";a+=getDetailHtml(c)}var b="confirmOrder";var e="payinfo";if(c.is_sell==2){b="confirmAccept";e="static1"}if(c.status==1||c.status==2){var d=P2P_formatSeconds(c.remaining_time);if(c.remaining_time<=0){a+="<td>"+c.remaining_time_str+"</td>"}else{a+='<td class="remaining_time" status-str="'+c.remaining_time_str+'" status="'+c.remaining_time_status+'" time="'+c.remaining_time+'">'+d+"</td>"}}else{if(c.status==8||c.status==0){a+="<td>-</td>"}else{a+="<td>"+c.time+"</td>"}}if(c.type_status==1&&c.complete_flag==0&&c.status==2){a+='<td><button type="button" data-toggle="modal" data-target="#payinfoMess"';a+=' order-id="'+c.id+'"';a+=' class="btn btn-xs bankInfo">'+c.type_str+"</button></td>"}else{if(c.type_status==1&&c.complete_flag==0&&c.status!=0){a+="<td>"+c.type_str+"</td>"}else{if(c.type_status==0&&c.complete_flag==0&&c.status!=0){a+='<td class="confirmBtn-'+c.id+'" ><button type="button" data-toggle="modal" data-target="#'+e+'"';a+=' order-id="'+c.id+'"';a+=' amount_count="'+c.abnormal_second+'"';a+=' class="btn btn-red btn-xs '+b+" confirmOrder-"+c.id+'">'+c.type_str+"</button></td>"}else{if(c.type_status==0&&c.complete_flag==0&&c.status==0){a+='<td><button type="button" data-toggle="modal" data-target="#cancel"';a+=' order-id="'+c.id+'"';a+=' class="btn btn-xs btn-red revokeNowOrder revokeNowOrder-'+c.id+'">'+c.type_str+"</button></td>"}}}}if(c.complete_flag==1){a+="<td>"+c.status_str+"</td>"}return a}function getDetailHtml(b){var a="";a+='<td><button type="button" data-toggle="modal" data-target="#detail"';a+=' order-num="'+b.order_num+'"';a+=' add-time="'+b.add_time+'"';a+=' trade-time="'+b.trade_time+'"';a+=' buy-moneytime="'+b.shoukuan_time+'"';a+=' end-time="'+b.end_time+'"';a+=' class="btn btn-xs getDetails">'+b.details+"</button></td>";return a}function getOrderDeatil(f){var d=f.attr("order-num");var a=f.attr("add-time");var c=f.attr("trade-time");var e=f.attr("buy-moneytime");var b=f.attr("end-time");$("#detail_order_num").html('<span id="d_order_num">'+d+'</span><button type="button" id="copy" style="position:relative;background-color: inherit;"  class="btn btn-green copyBtn" data-clipboard-action="copy" data-clipboard-target="#d_order_num"><svg class="icon input-icon icon-bz" style="left:5px;top:0px;" aria-hidden="true"><use xlink:href="#icon-ic_wallet_copy"></use></svg></button>');$("#detail_add_time").html(a);$("#detail_trade_time").html(c);$("#detail_dakuang_time").html(e);$("#detail_end_time").html(b)}function revokeOrderById(a){check_user("/OffTrading/revokeOrder",{order_id:a},"post").then(function(b){if(b.code==200){BottomalertBox("bottom",b.msg,"success","center");$(".order-list-id-"+a).remove();loadLate(800)}else{BottomalertBox("bottom",b.msg,"fail","center")}})}function SaleTotal(){if(!$("#coinNum").val()||!$("#touchspin-example4").val()){$(".saletotal,.referenceSaletotal").text("0.00");return}var a=$("#coinNum").val()*$("#touchspin-example4").val();a=ChangeFixed(a,3);$(".saletotal").text(a)}function referenceTotalPrice(){var b=$(".saletotal").text();var d=$("#userArea").val();var a=getPriceBychangeCoin(d);var c=b*a[1];if(d==2){c=ChangeFixed(c,1)+"00"}c=ChangeFixed(c,3);$(".referenceSaletotal").text(c)}function P2P_formatSeconds(e){var d=parseInt(e);var b=0;var c=0;if(d>60){b=parseInt(d/60);d=parseInt(d%60);if(b>60){c=parseInt(b/60);b=parseInt(b%60)}}var a=""+parseInt(d)+"s";if(b>0){a=""+parseInt(b)+"m"+a}if(c>0){a=""+parseInt(c)+"h"+a}return a};