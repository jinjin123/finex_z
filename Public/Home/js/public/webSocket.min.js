var server_url="ws://47.57.131.217:9502";var Inner_socket={msg:null,ws:{},heartbeat_timer:null,last_health:-1,health_timeout:60000,client_id:Date.parse(new Date()),config:{server:server_url,flash_websocket:true},disConnect_type:0,disConnect:null};$(document).ready(function(){if(window.WebSocket||window.MozWebSocket){Inner_socket.ws=new WebSocket(Inner_socket.config.server)}else{if(Inner_socket.config.flash_websocket){WEB_SOCKET_SWF_LOCATION="./flash-websocket/WebSocketMain.swf";$.getScript("./flash-websocket/swfobject.js",function(){$.getScript("./flash-websocket/web_socket.js",function(){Inner_socket.ws=new WebSocket(Inner_socket.config.server)})})}else{window.setInterval(function(){var a=$("#coinMoneyList li.active").attr("currency-id");a=a?a:$("#coinMoneyList li:nth-child(1)").attr("currency-id");target_webgetCoin(a)},20000);Inner_socket.ws=new Comet(Inner_socket.config.server)}}listenEvent()});function listenEvent(){Inner_socket.ws.onopen=function(c){target_web("join",Inner_socket.client_id,1,"pcCoinInfoList");Inner_socket.heartbeat_timer=setInterval(function(){keepalive()},10000)};var b=[];var a="";Inner_socket.ws.onmessage=function(m){var o=JSON.parse(m.data);var d=o.data.method;var n=o.data.service_name;if(d=="connection"){if(o.data.status==1){}}else{if(d=="push"&&n=="pcCoinInfoList"){var h=o.data.data;coin_Lowershelf(h);setGMV(h);var c=setCoinSocket(h);if(a==""){a=c.length;for(var l=0;l<c.length;l++){b.push({});b[l].coinName=c[l].coinName;b[l].arr=[];b[l].arr.push(0)}}else{a=a}if(a==c.length){for(var f=0;f<c.length;f++){if(b[f].arr.length>=10){b[f].arr.shift()}b[f].arr.push(c[f].lastUsa);b[f].color=c[f].color;b[f].id=c[f].currencyID;b[f].arrow=c[f].arrow;b[f].lastUsa=c[f].lastUsa;b[f].html=c[f].html}}for(var g=0;g<b.length;g++){$("#tab-underline-home3 .quoteprice_box[box-id = "+b[g].id+"] .kline").sparkline(b[g].arr,{type:"line",spotColor:b[g].color,lineColor:"#ffffff",fillColor:false,minSpotColor:b[g].color,maxSpotColor:b[g].color,})}}}};Inner_socket.ws.onclose=function(c){$(".websocketWarm").modal("show");clearInterval(Inner_socket.heartbeat_timer);Inner_socket.disConnect=setInterval(function(){Inner_socket.last_health=-1;Inner_socket.disConnect_type++;clearInterval(Inner_socket.disConnect);if(Inner_socket.disConnect_type==3){window.setInterval(function(){var d=$("#coinMoneyList li.active").attr("currency-id");d=d?d:$("#coinMoneyList li:nth-child(1)").attr("currency-id");target_webgetCoin(d)},20000)}else{if(Inner_socket.ws.readyState==1){$(".websocketWarm").modal("hide");return}Inner_socket.ws=new WebSocket(server_url);listenEvent()}},5000)};Inner_socket.ws.onerror=function(c){$(".pubArea").hide()}}function target_web(b,c,a,d){Inner_socket.msg={method:b,uid:c,hobby:a,service_name:d};Inner_socket.ws.send(JSON.stringify(Inner_socket.msg))}function setGMV(d){var c=$("#coinMoneyList li.active").attr("currency-id");c=c?c:$("#coinMoneyList li:nth-child(1)").attr("currency-id");$("#coinHeighMoney").html(d[c].high_usa);$("#coinLowMoney").html(d[c].low_usa);$("#coinRtqMoney").html(d[c].last_usa);$("#coinTotalMoney").html(d[c].money_usa);if(/CtoCTransaction/.test(window.location.href)){$(".release-rtq").text("$"+ChangeFixed(d[c].last_usa,3));$(".release-buyprice").val(ChangeFixed(d[c].last_usa,3));$(".release-sellprice").val(ChangeFixed(d[c].last_usa,3));release_hl($("#order-buyrelease"))}if(/UserCenter/.test(window.location.href)){var e=$("#userArea").val();var b=getPriceBychangeCoin(e);var a=ChangeFixed(d[c].last_usa,3)*b[1];if(e==2){a=ChangeFixed(a,1)+"00"}a=ChangeFixed(a,3);$("#referenceMoney").html(a);$("#nowMoney").html(ChangeFixed(d[c].last_usa,3))}}function setCoinSocket(e){var b=[];var d=[];for(var c in e){b.push(e[c])}$.each(b,function(h,k){var f,j;if(k.perc_status>0){f="#4bd2b7";j="fa fa-long-arrow-up"}else{f="#e8653b";j="fa fa-long-arrow-down"}var g=""+k.perc_per+'  <i class="'+j+'"></i>';$("#tab-underline-home3 .quoteprice_box[box-id = "+k.currency_id+"] .quote_nowprice div:eq(0)").css({color:f}).text(k.last_usa);$("#tab-underline-home3 .quoteprice_box[box-id = "+k.currency_id+"] .quote_volume .vol_font").css({color:f}).html(g);$("#tab-underline-home3 .quoteprice_box[box-id = "+k.currency_id+"] .quote_volume div:eq(0) .font11").text("Volume:"+k.num+" "+k.coin_name+"");d.push({});d[h].coinName=k.coin_name;d[h].lastUsa=k.last_usa;d[h].color=f;d[h].currencyID=k.currency_id;d[h].arrow=j;d[h].html=g});var a=d;return a}function keepalive(){var c=new Date();var b=c.getTime();var a=b-Inner_socket.last_health;if(Inner_socket.last_health!=-1&&(a>Inner_socket.health_timeout)){Inner_socket.ws.close()}else{if(Inner_socket.ws.readyState===1){Inner_socket.msg={method:"heartbeat"};Inner_socket.ws.send(JSON.stringify(Inner_socket.msg));Inner_socket.last_health=b}}}function target_webgetCoin(a){$.ajax({cache:true,type:"post",url:"/CoinTradeInfo/getCoinInfoList",data:{currencyId:a},dataType:"json",error:function(b){},beforeSend:function(){},success:function(b){setCoinSocket(b.coinInfoList);setGMV(b.coinInfoList)}})}window.onbeforeunload=function(){Inner_socket.ws.close()};